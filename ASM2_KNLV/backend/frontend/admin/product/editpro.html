<link rel="stylesheet" href="../css/edit.css">
<body>
    <form id="formProduct">
        <input type="hidden" id="productId"> <!-- Input ẩn để lưu ID sản phẩm -->
        <input type="text" name="name" placeholder="Tên sản phẩm">
        <input type="file" name="img">
        
        <!-- Hiển thị ảnh hiện tại nếu có -->
        <div id="productImageContainer">
            <img id="productImage" src="" alt="Ảnh sản phẩm" width="200">
        </div>
        
        <input type="text" name="price" placeholder="Giá">
        <select name="categoryId" id="categoryId"></select>
        <input type="text" name="description" placeholder="Mô tả">
        <button type="submit">Cập nhật sản phẩm</button>
    </form>

    <script>
       // Kiểm tra quyền Admin
const verifyAdminAccess = () => {
    const role = localStorage.getItem('role');
    const token = localStorage.getItem('token');

    if (!token || role !== 'admin') {
        alert("Bạn không có quyền truy cập!");
        window.location.href = "../../index.html"; // Chuyển hướng về trang đăng nhập
        return false;
    }
    return true;
};

// Lấy danh sách danh mục
fetch('http://localhost:3000/categories', {
    headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
    }
})
    .then(response => response.json())
    .then(data => {
        const categorySelect = document.getElementById('categoryId');
        data.forEach(category => {
            const option = document.createElement('option');
            option.value = category._id; // Lưu ID của category
            option.text = category.name; // Hiển thị tên của category   
            categorySelect.appendChild(option);
        });
    })
    .catch(error => console.error("Lỗi khi tải danh mục:", error));

// Lấy ID từ URL
const urlParams = new URLSearchParams(window.location.search);
const productId = urlParams.get("id");

// Nếu có ID thì lấy dữ liệu sản phẩm từ API
if (productId) {
    fetch(`http://localhost:3000/products/${productId}`, {
        headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
    })
        .then(response => response.json())
        .then(product => {
            document.getElementById("productId").value = product._id;
            document.querySelector("[name='name']").value = product.name;
            document.querySelector("[name='price']").value = product.price;
            document.querySelector("[name='description']").value = product.description;

            // Chọn đúng categoryId trong danh sách khi sửa sản phẩm
            document.querySelector("[name='categoryId']").value = product.categoryId._id; // Sử dụng _id của category

            // Hiển thị ảnh hiện tại nếu có
            const productImage = document.getElementById("productImage");

            if (product.img) {
                productImage.src = `http://localhost:3000/images/${product.img}`; // Đường dẫn ảnh hiện tại
            } else {
                productImage.alt = "Không có ảnh";
            }
        })
        .catch(error => console.error("Lỗi khi tải sản phẩm:", error));
}

// Xử lý cập nhật sản phẩm khi submit form
document.getElementById("formProduct").addEventListener("submit", async function(event) {
    event.preventDefault(); // Ngăn chặn load lại trang
    if (!verifyAdminAccess()) return; // Kiểm tra quyền Admin

    const formData = new FormData(this); // Lấy dữ liệu form

    try {
        const response = await fetch(`http://localhost:3000/products/${productId}`, {
            method: "PATCH",
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: formData // Gửi formData thay vì JSON
        });

        if (!response.ok) {
            throw new Error(`Lỗi: ${response.status}`);
        }

        alert("Cập nhật sản phẩm thành công!");
        window.location.href = "./product.html"; // Quay lại trang danh sách sản phẩm

    } catch (error) {
        console.error("Lỗi khi cập nhật sản phẩm:", error);
        alert("Không thể cập nhật sản phẩm!");
    }
});

// Kiểm tra quyền truy cập ngay khi tải trang
verifyAdminAccess();

    </script>
</body>
</html>
